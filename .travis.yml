dist: trusty

jobs:
  include:
    - stage: build and push docker image
      script:
      - export VERSION=`cat version.txt`
      - envsubst < "./index.temp" > "./index.html" 
      - echo "$DOCKER_PW" | docker login -u "$DOCKER_LOGIN" --password-stdin
      - docker build -t local/apachetest:$VERSION .
      - docker images
      - docker tag local/apachetest:$VERSION crownpeak/apachetest:$VERSION
      - docker push crownpeak/apachetest:$VERSION
    - stage: test
      script:
      - export VERSION=`cat version.txt`
      - docker pull crownpeak/apachetest:$VERSION 
      - docker run -d -p 80:80 crownpeak/apachetest:$VERSION
      - curl localhost:80
