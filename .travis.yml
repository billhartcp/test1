dist: trusty

jobs:
  include:
    - stage: build and push docker image
      script:
      - export VERSION=`cat version.txt`
      - envsubst < "./index.temp" > "./index.html" 
      - echo "$DOCKER_PW" | docker login -u "$DOCKER_LOGIN" --password-stdin
      - docker build -t local/apachetest:$TRAVIS_BRANCH-$VERSION .
      - docker images
      - docker tag local/apachetest:$TRAVIS_BRANCH-$VERSION crownpeak/apachetest:$TRAVIS_BRANCH-$VERSION
      - docker push crownpeak/apachetest:$TRAVIS_BRANCH-$VERSION
    - stage: test
      if: branch = dev
      script:
      - export VERSION=`cat version.txt`
      - echo "$DOCKER_PW" | docker login -u "$DOCKER_LOGIN" --password-stdin
      - docker pull crownpeak/apachetest:$VERSION 
      - docker run -d -p 80:80 crownpeak/apachetest:$TRAVIS_BRANCH-$VERSION
      - sleep 10
      - curl http://localhost:80
    - stage: deployment
      # Only deploy if this is production
      if: branch = prod
      - provider: script:
        script: bash setk8s.sh
      # Do anything further to deploy to K8s stack.
